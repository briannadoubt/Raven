<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 Test - No Auto Re-render</title>
    <link rel="stylesheet" href="todoapp.css">
</head>
<body>
    <div id="loading">Loading V3 (no auto re-render)...</div>
    <div id="root" style="display: none;"></div>

    <script src="runtime.js"></script>
    <script>
        window.__ravenAddEventListener = function(element, eventName, handler) {
            if (element && typeof element.addEventListener === 'function' && typeof handler === 'function') {
                const wrappedHandler = function(event) {
                    console.log('[RAVEN] üî• Event fired:', eventName, 'on', element.tagName);
                    try {
                        const result = handler(event);
                        return result;
                    } catch (error) {
                        console.error('[RAVEN] ‚ùå Error in handler:', error);
                        throw error;
                    }
                };
                element.addEventListener(eventName, wrappedHandler);
                return true;
            }
            return false;
        };
    </script>

    <script type="module">
        const wasiPolyfill = {
            args_get: () => 0, args_sizes_get: () => 0, environ_get: () => 0, environ_sizes_get: () => 0,
            clock_res_get: () => 0, clock_time_get: () => 0, fd_advise: () => 0, fd_allocate: () => 0,
            fd_close: () => 0, fd_datasync: () => 0, fd_fdstat_get: () => 0, fd_fdstat_set_flags: () => 0,
            fd_fdstat_set_rights: () => 0, fd_filestat_get: () => 0, fd_filestat_set_size: () => 0,
            fd_filestat_set_times: () => 0, fd_pread: () => 0, fd_prestat_get: () => 0,
            fd_prestat_dir_name: () => 0, fd_pwrite: () => 0, fd_read: () => 0, fd_readdir: () => 0,
            fd_renumber: () => 0, fd_seek: () => 0, fd_sync: () => 0, fd_tell: () => 0,
            fd_write: () => 0, path_create_directory: () => 0, path_filestat_get: () => 0,
            path_filestat_set_times: () => 0, path_link: () => 0, path_open: () => 0,
            path_readlink: () => 0, path_remove_directory: () => 0, path_rename: () => 0,
            path_symlink: () => 0, path_unlink_file: () => 0, poll_oneoff: () => 0,
            proc_exit: (code) => console.log('[WASM] Exit:', code), proc_raise: () => 0,
            sched_yield: () => 0, random_get: () => 0, sock_recv: () => 0, sock_send: () => 0,
            sock_shutdown: () => 0
        };

        async function loadWASM() {
            try {
                const wasmFile = 'TodoApp-v3-1770312867.wasm';
                console.log('üöÄ Loading V3:', wasmFile);

                const response = await fetch(wasmFile);
                const bytes = await response.arrayBuffer();
                console.log(`üì¶ ${(bytes.byteLength / 1024 / 1024).toFixed(2)} MB`);

                const { SwiftRuntime } = JavaScriptKit;
                const swift = new SwiftRuntime();

                const { instance } = await WebAssembly.instantiate(bytes, {
                    wasi_snapshot_preview1: wasiPolyfill,
                    javascript_kit: swift.importObjects(),
                });

                swift.setInstance(instance);
                if (instance.exports._initialize) instance.exports._initialize();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('root').style.display = 'block';

                if (instance.exports._start) instance.exports._start();
                console.log('‚úÖ V3 started! Testing re-render fix...');
            } catch (error) {
                console.error('‚ùå Load error:', error);
            }
        }

        if (typeof JavaScriptKit !== 'undefined') {
            loadWASM();
        }
    </script>
</body>
</html>
