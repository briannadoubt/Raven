<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raven Component Showcase</title>
</head>
<body>
    <!-- Loading indicator shown before WASM initializes -->
    <div id="loading" style="display:flex;align-items:center;justify-content:center;min-height:100vh;font-family:system-ui,sans-serif;color:#666;">
        <p>Loading Raven Showcase...</p>
    </div>

    <!-- Root element for Raven to mount to -->
    <div id="root" style="display:none;"></div>

    <!-- JavaScriptKit Runtime -->
    <script src="runtime.js"></script>

    <!-- Raven Event Handler Helper -->
    <script>
        window.__ravenEvents = [];
        window.__ravenAddEventListener = function(element, eventName, handler) {
            window.__ravenEvents.push({
                element: element ? element.tagName : 'null',
                eventName: eventName,
                handlerType: typeof handler
            });
            if (element && typeof element.addEventListener === 'function' && typeof handler === 'function') {
                const wrappedHandler = function(event) {
                    try {
                        return handler(event);
                    } catch (error) {
                        console.error('[RAVEN] Handler error:', error);
                        throw error;
                    }
                };
                element.addEventListener(eventName, wrappedHandler);
                return true;
            }
            return false;
        };
        window.__ravenRemoveEventListener = function(element, eventName, handler) {
            if (element && typeof element.removeEventListener === 'function') {
                element.removeEventListener(eventName, handler);
                return true;
            }
            return false;
        };
    </script>

    <script type="module">
        let wasmMemory;
        const wasiPolyfill = {
            args_get: () => 0,
            args_sizes_get: () => 0,
            environ_get: () => 0,
            environ_sizes_get: () => 0,
            clock_res_get: () => 0,
            clock_time_get: () => 0,
            fd_advise: () => 0,
            fd_allocate: () => 0,
            fd_close: () => 0,
            fd_datasync: () => 0,
            fd_fdstat_get: () => 0,
            fd_fdstat_set_flags: () => 0,
            fd_fdstat_set_rights: () => 0,
            fd_filestat_get: () => 0,
            fd_filestat_set_size: () => 0,
            fd_filestat_set_times: () => 0,
            fd_pread: () => 0,
            fd_prestat_get: () => 0,
            fd_prestat_dir_name: () => 0,
            fd_pwrite: () => 0,
            fd_read: () => 0,
            fd_readdir: () => 0,
            fd_renumber: () => 0,
            fd_seek: () => 0,
            fd_sync: () => 0,
            fd_tell: () => 0,
            fd_write: (fd, iov, iovcnt, nwritten) => {
                if ((fd === 1 || fd === 2) && wasmMemory) {
                    try {
                        const buffers = new Uint32Array(wasmMemory.buffer, iov, iovcnt * 2);
                        let output = '';
                        for (let i = 0; i < iovcnt; i++) {
                            const ptr = buffers[i * 2];
                            const len = buffers[i * 2 + 1];
                            const buffer = new Uint8Array(wasmMemory.buffer, ptr, len);
                            output += new TextDecoder().decode(buffer);
                        }
                        if (fd === 1) console.log('[Swift]', output);
                        else console.error('[Swift Error]', output);
                        if (nwritten) new Uint32Array(wasmMemory.buffer, nwritten, 1)[0] = output.length;
                        return 0;
                    } catch (e) {
                        console.error('fd_write error:', e);
                        return -1;
                    }
                }
                return 0;
            },
            path_create_directory: () => 0,
            path_filestat_get: () => 0,
            path_filestat_set_times: () => 0,
            path_link: () => 0,
            path_open: () => 0,
            path_readlink: () => 0,
            path_remove_directory: () => 0,
            path_rename: () => 0,
            path_symlink: () => 0,
            path_unlink_file: () => 0,
            poll_oneoff: () => 0,
            proc_exit: (code) => { console.log('[WASM] Exit code:', code); },
            proc_raise: () => 0,
            sched_yield: () => 0,
            random_get: () => 0,
            sock_recv: () => 0,
            sock_send: () => 0,
            sock_shutdown: () => 0,
        };

        async function loadWASM() {
            try {
                const response = await fetch('TodoApp.wasm?t=' + Date.now());
                if (!response.ok) throw new Error('Failed to fetch WASM: ' + response.status);
                const bytes = await response.arrayBuffer();
                console.log('Loaded ' + (bytes.byteLength / 1024 / 1024).toFixed(2) + ' MB');

                const { SwiftRuntime } = JavaScriptKit;
                const swift = new SwiftRuntime();
                const { instance } = await WebAssembly.instantiate(bytes, {
                    wasi_snapshot_preview1: wasiPolyfill,
                    javascript_kit: swift.importObjects(),
                });

                wasmMemory = instance.exports.memory;
                swift.setInstance(instance);

                if (instance.exports._initialize) instance.exports._initialize();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('root').style.display = 'block';

                if (instance.exports._start) {
                    instance.exports._start();
                }
            } catch (error) {
                console.error('Failed to load WASM:', error);
                document.getElementById('loading').textContent = 'Failed to load: ' + error.message;
            }
        }

        if (typeof JavaScriptKit !== 'undefined') loadWASM();
        else console.error('JavaScriptKit runtime not loaded!');
    </script>
</body>
</html>
