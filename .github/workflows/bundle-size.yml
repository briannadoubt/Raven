name: Bundle Size Check

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .build
            Examples/TodoApp/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build framework
        run: swift build

      - name: Install Swift WASM SDK
        run: |
          swift sdk install https://github.com/nicktmro/aspect-swift/releases/download/0.0.2/swift-6.0.3-RELEASE_wasm32-unknown-wasi.artifactbundle.tar.gz 2>/dev/null \
            || swift sdk install https://github.com/nicktmro/aspect-swift/releases/download/0.0.2/swift-6.0.3-RELEASE_wasm32-unknown-wasi.artifactbundle.zip 2>/dev/null \
            || echo "⚠️ WASM SDK install failed, skipping WASM build"
          swift sdk list || true

      - name: Build TodoApp for WASM
        working-directory: Examples/TodoApp
        run: |
          SDK_NAME=$(swift sdk list 2>/dev/null | grep -i wasm | head -1 | xargs || echo "")
          if [ -n "$SDK_NAME" ]; then
            echo "Building with SDK: $SDK_NAME"
            swift build --swift-sdk "$SDK_NAME"
            SIZE=$(stat -c%s .build/debug/TodoApp.wasm)
            SIZE_KB=$(awk "BEGIN {printf \"%.1f\", $SIZE/1024}")
            echo "✅ WASM build succeeded: ${SIZE_KB}KB"
          else
            echo "⚠️ No WASM SDK available, skipping WASM build"
          fi

      - name: Create status check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Bundle Size',
              head_sha: context.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'Build succeeded',
                summary: 'Framework build completed successfully'
              }
            });
